name: Deploy + Sync MongoDB

on:
  push:
    branches:
      - main

  schedule:
    - cron: "*/10 * * * *"   # Every 10 minutes

jobs:

  deploy_to_infinityfree:
    name: Deploy to InfinityFree
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: Deploy Files
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          if [ -z "$FTP_HOST" ] || [ -z "$FTP_USER" ] || [ -z "$FTP_PASSWORD" ]; then
            echo "‚ùå FTP credentials missing."
            exit 1
          fi

          echo "üöÄ Deploying to InfinityFree..."

          lftp -e "
            set ftp:ssl-allow no;
            set mirror:use-pget-n 2;
            set net:timeout 60;

            open -u $FTP_USER,$FTP_PASSWORD $FTP_HOST;

            mirror -R -v --parallel=2 \
              --exclude-glob .git/ \
              --exclude-glob .github/ \
              --exclude-glob .env \
              --exclude-glob README.md \
              ./ /htdocs/;

            bye
          "

          echo "‚úÖ Deployment completed"


  sync_mongodb:
    name: Sync logs.json ‚Üí MongoDB
    runs-on: ubuntu-latest
    needs: deploy_to_infinityfree

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Python + lftp
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip lftp

      - name: Install Python dependencies
        run: pip install pymongo pandas dnspython python-dateutil

      - name: Download logs.json from InfinityFree
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          echo "‚¨áÔ∏è Downloading logs.json..."

          lftp -e "
            set ftp:ssl-allow no;
            set xfer:clobber yes;

            open -u $FTP_USER,$FTP_PASSWORD $FTP_HOST;

            get /htdocs/logs.json -o logs.json \
              || echo '[]' > logs.json;

            bye
          "

      - name: Run MongoDB sync script
        timeout-minutes: 10
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}
        run: |
          if [ -z "$MONGO_URI" ]; then
            echo '‚ùå MONGO_URI is not set'
            exit 1
          fi

          echo "üöÄ Starting MongoDB sync..."

          python3 sync_logs_to_mongo.py || {
            echo "‚ùå Sync failed, but continuing..."
            exit 0
          }

      - name: Upload stats_actions.csv to InfinityFree
        if: success()
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          if [ -f stats_actions.csv ]; then
            echo "üì§ Uploading stats_actions.csv..."

            lftp -e "
              set ftp:ssl-allow no;
              set xfer:clobber yes;
              open -u $FTP_USER,$FTP_PASSWORD $FTP_HOST;
              put stats_actions.csv -o /htdocs/stats_actions.csv;
              bye
            "
          else
            echo "‚ö†Ô∏è stats_actions.csv not found"
          fi
