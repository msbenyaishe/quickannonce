name: Deploy & Sync Logs

on:
  push:
    branches: [main]
  schedule:
    - cron: '*/10 * * * *'  # Every 10 minutes

jobs:
  deploy-and-sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Install lftp at the beginning of the job
      - name: Install FTP client
        run: sudo apt-get update && sudo apt-get install -y lftp

      # --- Deployment (only on push) ---
      - name: Deploy to InfinityFree
        if: github.event_name == 'push'
        env:
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          FTP_HOST: ${{ secrets.FTP_HOST }}
        run: |
          echo "üöÄ Starting deployment to InfinityFree..."
          lftp -c "
            set ssl:verify-certificate no;
            open -u $FTP_USER,$FTP_PASS $FTP_HOST;
            mirror -R ./ /htdocs/ --ignore-time --parallel=2 --exclude-glob .git* --exclude .github/
          "
          echo "‚úÖ Deployment completed"

      # --- Log Synchronization ---
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pymongo pandas python-dotenv

      - name: Download logs.json
        id: download-logs
        env:
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          FTP_HOST: ${{ secrets.FTP_HOST }}
        run: |
          echo "üì• Downloading logs.json..."
          # Create a backup of the current logs
          lftp -c "
            set ssl:verify-certificate no;
            open -u $FTP_USER,$FTP_PASS $FTP_HOST;
            get /htdocs/logs.json -o logs_backup.json || true
          "
          
          # Download the main logs file
          lftp -c "
            set ssl:verify-certificate no;
            set xfer:clobber on;
            open -u $FTP_USER,$FTP_PASS $FTP_HOST;
            get /htdocs/logs.json -o logs.json;
          " || true
          
          # If download failed, create an empty file
          if [ ! -f "logs.json" ]; then
            echo "[]" > logs.json
            echo "‚ÑπÔ∏è Created empty logs.json"
          fi

      - name: Run log synchronization
        id: sync-logs
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}
          MONGO_DB: ${{ secrets.MONGO_DB }}
          MONGO_COLLECTION: ${{ secrets.MONGO_COLLECTION }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          FTP_HOST: ${{ secrets.FTP_HOST }}
        run: |
          echo "üîå Using MongoDB database: ${MONGO_DB}"
          
          # First, verify we can connect to MongoDB
          python - <<'EOF'
import os, sys
from pymongo import MongoClient

mongo_uri = os.getenv("MONGO_URI")
try:
    client = MongoClient(mongo_uri)
    client.server_info()  # Will throw if can't connect
    print("‚úÖ Successfully connected to MongoDB")
except Exception as e:
    print(f"‚ùå Failed to connect to MongoDB: {str(e)}")
    sys.exit(1)
EOF
          
          # Process logs but don't clear the file yet
          if ! python sync_logs_to_mongo.py --no-clear; then
              echo "‚ùå Log processing failed"
              exit 1
          fi
          
          # Clear the file only if processing was successful
          echo "[]" > logs.json
          echo "‚úÖ Logs processed successfully"

      - name: Upload updated files
        if: steps.sync-logs.outcome == 'success'
        env:
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          FTP_HOST: ${{ secrets.FTP_HOST }}
        run: |
          echo "üì§ Uploading updated files..."
          
          # Upload logs.json (now empty)
          lftp -c "
            set ssl:verify-certificate no;
            open -u $FTP_USER,$FTP_PASS $FTP_HOST;
            put -O /htdocs/ logs.json;
          "
          
          # Upload logs.csv if it exists
          if [ -f "logs.csv" ]; then
            lftp -c "
              set ssl:verify-certificate no;
              open -u $FTP_USER,$FTP_PASS $FTP_HOST;
              put -O /htdocs/ logs.csv;
            "
          fi
          
          # Upload stats_actions.csv if it exists
          if [ -f "stats_actions.csv" ]; then
            lftp -c "
              set ssl:verify-certificate no;
              open -u $FTP_USER,$FTP_PASS $FTP_HOST;
              put -O /htdocs/ stats_actions.csv;
            "
          fi
          
          echo "‚úÖ Files uploaded successfully"

      - name: Cleanup on failure
        if: failure()
        env:
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          FTP_HOST: ${{ secrets.FTP_HOST }}
        run: |
          echo "‚ö†Ô∏è Workflow failed, restoring logs.json from backup if available"
          if [ -f "logs_backup.json" ]; then
            echo "üîÑ Restoring logs.json from backup"
            mv logs_backup.json logs.json
            # Upload the restored logs.json
            lftp -c "
              set ssl:verify-certificate no;
              open -u $FTP_USER,$FTP_PASS $FTP_HOST;
              put -O /htdocs/ logs.json;
            "
          fi
