name: Deploy & Sync Logs

on:
  push:
    branches: [main]
  schedule:
    - cron: '*/10 * * * *'  # Every 10 minutes

jobs:
  deploy-and-sync:
    runs-on: ubuntu-latest
    env:
      # Set default values for all steps
      MONGO_DB: ${{ secrets.MONGO_DB || 'logs_db' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # --- Install Dependencies ---
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp

      # --- Deployment (only on push) ---
      - name: Deploy to InfinityFree
        if: github.event_name == 'push'
        env:
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          FTP_HOST: ${{ secrets.FTP_HOST }}
        run: |
          echo "ðŸš€ Starting deployment to InfinityFree..."
          lftp -c "
            set ssl:verify-certificate no;
            set xfer:clobber on;
            open -u $FTP_USER,$FTP_PASS $FTP_HOST;
            mirror -R ./ /htdocs/ \
              --ignore-time \
              --parallel=2 \
              --exclude-glob .git* \
              --exclude .github/ \
              --exclude *.py \
              --exclude *.md \
              --exclude .gitignore
          "
          echo "âœ… Deployment completed"

      # --- Log Synchronization ---
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt  # Consider adding a requirements.txt

      - name: Download logs.json
        env:
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          FTP_HOST: ${{ secrets.FTP_HOST }}
        run: |
          echo "ðŸ“¥ Downloading logs.json..."
          rm -f logs.json
          lftp -c "
            set ssl:verify-certificate no;
            set xfer:clobber on;
            open -u $FTP_USER,$FTP_PASS $FTP_HOST;
            get /htdocs/logs.json -o logs.json;
          " || true
          
          if [ ! -f "logs.json" ]; then
            echo "[]" > logs.json
            echo "â„¹ï¸ Created empty logs.json"
          fi

      - name: Run log synchronization
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}
          # MONGO_DB is set at job level
        run: |
          echo "ðŸ”Œ Using MongoDB database: $MONGO_DB"
          python sync_logs_to_mongo.py

      - name: Upload updated files
        if: always()  # Always run this step even if previous steps fail
        env:
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          FTP_HOST: ${{ secrets.FTP_HOST }}
        run: |
          echo "ðŸ“¤ Uploading updated files..."
          
          # Create empty files if they don't exist
          [ -f "logs.csv" ] || echo "No logs" > logs.csv
          [ -f "stats_actions.csv" ] || echo "No stats" > stats_actions.csv
          
          lftp -c "
            set ssl:verify-certificate no;
            set xfer:clobber on;
            open -u $FTP_USER,$FTP_PASS $FTP_HOST;
            put -O /htdocs/ logs.csv;
            put -O /htdocs/ stats_actions.csv;
            put -O /htdocs/ logs.json;
          "
          echo "âœ… Files uploaded successfully"

      - name: Clean up
        if: always()
        run: |
          # Clean up sensitive files
          rm -f logs.json logs.csv stats_actions.csv