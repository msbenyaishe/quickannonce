name: Deploy & Sync Logs

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual triggering
  schedule:
    - cron: "*/10 * * * *"  # Run every 10 minutes

jobs:
  deploy_and_sync:
    name: Deploy + Sync Logs
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Deployment to InfinityFree ---
      - name: Deploy to InfinityFree
        if: github.event_name == 'push'  # Only run on push events
        env:
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          FTP_HOST: ${{ secrets.FTP_HOST }}
        run: |
          echo "üöÄ Starting deployment to InfinityFree..."
          lftp -c "
            set ssl:verify-certificate no;
            open -u $FTP_USER,$FTP_PASS $FTP_HOST;
            mirror -R ./ /htdocs/ --ignore-time --parallel=2 --exclude-glob .git* --exclude .github/
          "
          echo "‚úÖ Deployment completed"

      # --- Log Synchronization ---
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pymongo pandas python-dotenv

      - name: Install FTP client
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: Download logs.json
        env:
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          FTP_HOST: ${{ secrets.FTP_HOST }}
        run: |
          echo "üì• Downloading logs.json..."
          if ! lftp -c "set ssl:verify-certificate no; open -u $FTP_USER,$FTP_PASS $FTP_HOST; get /htdocs/logs.json -o logs.json"; then
            echo "[]" > logs.json
            echo "‚ÑπÔ∏è Created empty logs.json"
          fi

      - name: Run log synchronization
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}
        run: |
          python sync_logs_to_mongo.py

      - name: Upload updated files
        env:
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          FTP_HOST: ${{ secrets.FTP_HOST }}
        run: |
          echo "üì§ Uploading updated files..."
          lftp -c "
            set ssl:verify-certificate no;
            open -u $FTP_USER,$FTP_PASS $FTP_HOST;
            put -O /htdocs/ logs.csv;
            put -O /htdocs/ stats_actions.csv;
            put -O /htdocs/ logs.json;
          "
          echo "‚úÖ Files uploaded successfully"