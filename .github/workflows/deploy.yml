name: Deploy + Sync MongoDB

on:
  push:
    branches:
      - main
  schedule:
    - cron: "*/10 * * * *"

jobs:
  sync_and_deploy:
    name: Sync logs.json ‚Üí MongoDB ‚Üí CSV ‚Üí upload
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install tools (lftp, python deps)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y lftp python3 python3-pip
          python3 -m pip install --upgrade pip
          pip install pymongo dnspython

      - name: Download logs.json from InfinityFree (create empty if missing)
        env:
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          FTP_HOST: ${{ secrets.FTP_HOST }}
        run: |
          echo "üì• Downloading /htdocs/logs.json from $FTP_HOST..."
          rm -f logs.json
          if lftp -c "set ssl:verify-certificate no; open -u $FTP_USER,$FTP_PASS $FTP_HOST; get /htdocs/logs.json -o logs.json"; then
            echo "‚úÖ logs.json downloaded."
          else
            echo "‚ö† logs.json not found on server. Creating empty logs.json with []"
            echo "[]" > logs.json
          fi
          echo "---- logs.json preview ----"
          head -c 800 logs.json || true
          echo
          ls -l logs.json

      - name: Check MONGO_URI secret is present
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}
        run: |
          if [ -z "$MONGO_URI" ]; then
            echo "‚ùå MONGO_URI is empty or not available to this run."
            exit 1
          else
            echo "‚úÖ MONGO_URI present (length=${#MONGO_URI})."
          fi

      - name: Validate logs.json format
        run: |
          if [ -s logs.json ]; then
            python3 -m json.tool logs.json >/dev/null || (echo "‚ùå logs.json is invalid JSON" && exit 1)
            echo "‚úÖ logs.json is valid JSON"
          else
            echo "‚ö† logs.json is empty (allowed)"
          fi

      - name: Sync with MongoDB (run Python)
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}
          MONGO_DB: ${{ secrets.MONGO_DB }}
          MONGO_COLLECTION: ${{ secrets.MONGO_COLLECTION }}
        run: |
          echo "üì° Syncing logs to MongoDB..."
          python3 sync_logs_to_mongo.py || (echo "‚ùå Sync failed" && exit 1)

      - name: Upload logs.csv to server
        env:
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          FTP_HOST: ${{ secrets.FTP_HOST }}
        run: |
          if [ -f logs.csv ]; then
            echo "üì§ Uploading logs.csv..."
            lftp -c "set ssl:verify-certificate no; open -u $FTP_USER,$FTP_PASS $FTP_HOST; put logs.csv -o /htdocs/logs.csv"
            echo "‚úÖ logs.csv uploaded."
          else
            echo "‚ö† logs.csv not found, skipping upload"
          fi

      - name: Upload stats_actions.csv to server
        env:
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          FTP_HOST: ${{ secrets.FTP_HOST }}
        run: |
          if [ -f stats_actions.csv ]; then
            echo "üì§ Uploading stats_actions.csv..."
            lftp -c "set ssl:verify-certificate no; open -u $FTP_USER,$FTP_PASS $FTP_HOST; put stats_actions.csv -o /htdocs/stats_actions.csv"
            echo "‚úÖ stats_actions.csv uploaded."
          else
            echo "‚ö† stats_actions.csv not found, skipping upload"
          fi

      - name: Upload cleared logs.json back to server (keep admin-console in sync)
        env:
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          FTP_HOST: ${{ secrets.FTP_HOST }}
        run: |
          if [ -f logs.json ]; then
            echo "üì§ Uploading logs.json (should be cleared to [] )..."
            lftp -c "set ssl:verify-certificate no; open -u $FTP_USER,$FTP_PASS $FTP_HOST; put logs.json -o /htdocs/logs.json"
            echo "‚úÖ logs.json uploaded."
          else
            echo "‚ö† logs.json not found, skipping upload"
          fi