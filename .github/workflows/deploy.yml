name: Deploy + Sync MongoDB

env:
  MONGO_URI: "mongodb+srv://quick_user_second:DfhuouESRXAuoJ1d@cluster0.kr90782.mongodb.net/logs_db?retryWrites=true&w=majority"

on:
  push:
    branches:
      - main
  schedule:
    - cron: "*/10 * * * *"

jobs:
  deploy:
    name: Deploy to InfinityFree
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install lftp
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp

      - name: Deploy via FTP
        env:
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          FTP_HOST: ${{ secrets.FTP_HOST }}
        run: |
          echo "üöÄ Deploying to InfinityFree..."
          lftp -c "set ssl:verify-certificate no; open -u $FTP_USER,$FTP_PASS $FTP_HOST; mirror -R ./ /htdocs/ --ignore-time --parallel=2"
          echo "‚úÖ Deployment done."

  sync_mongodb:
    name: Sync logs.json ‚Üí MongoDB
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Python dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp python3 python3-pip
          pip install pymongo pandas dnspython

      - name: Download logs.json from InfinityFree
        env:
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          FTP_HOST: ${{ secrets.FTP_HOST }}
        run: |
          echo "üì• Downloading logs.json..."
          rm -f logs.json
          if lftp -c "set ssl:verify-certificate no; open -u $FTP_USER,$FTP_PASS $FTP_HOST; get /htdocs/logs.json -o logs.json"; then
            echo "‚úÖ logs.json downloaded."
          else
            echo "‚ö† logs.json introuvable sur le serveur, cr√©ation d'un fichier vide."
            echo "[]" > logs.json
          fi

      - name: Sync with MongoDB
        run: |
          echo "üì° Syncing logs to MongoDB..."
          python3 sync_logs_to_mongo.py || (echo "‚ùå Sync failed" && exit 1)

      - name: Upload stats_actions.csv
        env:
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          FTP_HOST: ${{ secrets.FTP_HOST }}
        run: |
          if [ -f stats_actions.csv ]; then
            echo "üì§ Uploading stats_actions.csv..."
            lftp -c "set ssl:verify-certificate no; open -u $FTP_USER,$FTP_PASS $FTP_HOST; put stats_actions.csv -o /htdocs/stats_actions.csv"
            echo "‚úÖ stats_actions.csv uploaded."
          else
            echo "‚ö† stats_actions.csv not found"
          fi

      - name: Upload logs.csv
        env:
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          FTP_HOST: ${{ secrets.FTP_HOST }}
        run: |
          if [ -f logs.csv ]; then
            echo "üì§ Uploading logs.csv..."
            lftp -c "set ssl:verify-certificate no; open -u $FTP_USER,$FTP_PASS $FTP_HOST; put logs.csv -o /htdocs/logs.csv"
            echo "‚úÖ logs.csv uploaded."
          else
            echo "‚ö† logs.csv not found"
          fi