name: Deploy & Sync Logs

on:
  push:
    branches: [main]
  schedule:
    - cron: '*/10 * * * *' # Every 10 minutes

jobs:
  deploy-and-sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Install FTP client
      - name: Install FTP client
        run: sudo apt-get update && sudo apt-get install -y lftp

      # Setup Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pymongo pandas python-dotenv

      # Download logs.json from FTP
      - name: Download logs.json
        env:
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          FTP_HOST: ${{ secrets.FTP_HOST }}
        run: |
          rm -f logs.json
          lftp -c "
            set ssl:verify-certificate no;
            set ftp:passive-mode on;
            set xfer:clobber on;
            open -u $FTP_USER,$FTP_PASS $FTP_HOST;
            get /htdocs/logs.json -o logs.json
          " || true
          if [ ! -f "logs.json" ]; then
            echo "[]" > logs.json
          fi

      # Run Python sync script
      - name: Sync logs to MongoDB & generate CSVs
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}
          MONGO_DB: ${{ secrets.MONGO_DB }}
          MONGO_COLLECTION: logs
        run: |
          python sync_logs_to_mongo.py

      # Deploy all files including updated CSVs
      - name: Deploy to InfinityFree
        env:
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          FTP_HOST: ${{ secrets.FTP_HOST }}
        run: |
          echo "ðŸš€ Deploying files..."
          lftp -c "
            set ssl:verify-certificate no;
            set ftp:passive-mode on;
            open -u $FTP_USER,$FTP_PASS $FTP_HOST;
            mirror -R ./ /htdocs/ --ignore-time --parallel=2 --exclude-glob .git* --exclude .github/
          "
          echo "âœ… Deployment completed"
